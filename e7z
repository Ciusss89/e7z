#!/bin/bash

command=
key=

while [ $# -gt 0 ] 
do 
	case $1 in 
		a)	command=a; ;; 
		x)	command=x; ;;
		-k)	key=$2; shift ;; 
		-*)
            		echo >&2 "usage: $0 a|x -k keyfile ..."
	    		exit 1;;
		*)	break;;	# terminate while loop
	esac
	shift
done

echo command=$command
echo key=$key

archiveCommand=/usr/bin/7z

case $command in
	a)
		input=*.txt
		output=test.7z

		archivePassword=`makepasswd --chars=30`
		echo "Archive password: $archivePassword"

		# openssl rsa -in .ssh/id_rsa  -pubout -outform PEM > key.pub
		encryptedPasswordFile=/tmp/archivePassword.ssl
		echo $archivePassword | openssl rsautl -encrypt -inkey $key -pubin -out $encryptedPasswordFile
		#trap rm -f /tmp/archivePassword.ssl
		$archiveCommand a $output $encryptedPasswordFile
		$archiveCommand u -p$archivePassword $output $input
		;;
	x)
		;;
esac

exit 0